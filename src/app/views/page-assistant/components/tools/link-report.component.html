<p-table
  [value]="filteredHeadings"
  size="small"
  stripedRows
  [tableStyle]="{ 'min-width': '50rem' }"
  selectionMode="single"
  [(selection)]="selectedHeading"
  dataKey="order"
  metaKeySelection="false"
>
  <ng-template pTemplate="header">
    <tr>
      <th style="width: 3rem"></th>

      <th *ngFor="let col of cols">
        <div class="header-with-filter">
          <span>{{ col.header }}</span>

          <!-- Down-arrow filter button ONLY for Link Type -->
          <button
            *ngIf="col.field === 'type'"
            pButton
            type="button"
            class="p-button-text p-button-sm"
            icon="pi pi-chevron-down"
            (click)="typePanel?.toggle($event)"
            aria-label="Filter link types"
          ></button>
        </div>
      </th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-rowData let-rowIndex="rowIndex">
    <tr [pReorderableRow]="rowIndex" [pSelectableRow]="rowData">
      <td><span class="pi pi-bars" pReorderableRowHandle></span></td>

      <td *ngFor="let col of cols">
        <ng-container [ngSwitch]="col.field">
          <span *ngSwitchCase="'order'">{{ rowData.order }}</span>

          <span *ngSwitchCase="'type'">{{ rowData.type }}</span>

          <span
            *ngSwitchCase="'text'"
            [ngClass]="getTextClass(rowData)"
            [ngStyle]="getTextStyle(rowData)"
          >
            {{ rowData.text }}
            <div class="muted" *ngIf="rowData.href">({{ rowData.href }})</div>
          </span>

          <span *ngSwitchCase="'destH1'" class="break-all">
            {{ rowData.destH1 || "—" }}
          </span>

          <span *ngSwitchCase="'matchStatus'" class="flex justify-center">
            <i
              *ngIf="rowData.matchStatus === 'match'"
              class="pi pi-check-circle text-ok"
              title="Match"
            ></i>
            <i
              *ngIf="rowData.matchStatus === 'mismatch'"
              class="pi pi-times-circle text-bad"
              title="Mismatch"
            ></i>
            <i
              *ngIf="
                rowData.matchStatus === 'unknown' ||
                rowData.matchStatus === 'na'
              "
              class="pi pi-question-circle text-unk"
              title="Unknown"
            ></i>
          </span>

          <!-- Search term / Clicks and any other fields -->
          <span *ngSwitchDefault>{{ rowData[col.field] || "—" }}</span>
        </ng-container>
      </td>
    </tr>
  </ng-template>
</p-table>

<!-- Move the overlay OUTSIDE the table to avoid table parser issues -->
<p-overlayPanel
  #typePanel
  [dismissable]="true"
  [showCloseIcon]="true"
  [appendTo]="'body'"
>
  <div class="filter-panel">
    <!-- ALL (default checked) -->
    <div class="filter-row">
      <p-checkbox
        [(ngModel)]="allSelected"
        (onChange)="onAllToggle()"
        inputId="allTypes"
        binary="true"
      ></p-checkbox>
      <label class="filter-label" for="allTypes">ALL</label>
    </div>

    <div class="divider"></div>

    <!-- Six types (default unchecked; disabled while ALL is checked) -->
    <div class="filter-row" *ngFor="let t of linkTypes; let i = index">
      <p-checkbox
        [(ngModel)]="typeChecks[t]"
        (onChange)="onTypeToggle(t)"
        [disabled]="allSelected"
        [inputId]="'type-' + i"
        binary="true"
      ></p-checkbox>
      <label
        class="filter-label"
        [attr.for]="'type-' + i"
        (click)="toggleType(t)"
      >
        {{ t }}
      </label>
    </div>

    <div class="filter-muted" *ngIf="allSelected">
      All types are currently included.
    </div>
  </div>
</p-overlayPanel>
