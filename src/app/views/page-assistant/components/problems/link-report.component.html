<p-table
  [value]="filteredHeadings"
  size="small"
  stripedRows
  [tableStyle]="{ 'min-width': '50rem' }"
  selectionMode="single"
  [(selection)]="selectedHeading"
  dataKey="order"
  metaKeySelection="false"
  [customSort]="true"
  (sortFunction)="onCustomSort($event)"
>
  <ng-template pTemplate="header">
    <tr>
      <th style="width: 3rem"></th>

      <th
        *ngFor="let col of cols"
        [pSortableColumn]="
          col.field === 'order' || col.field === 'matchStatus'
            ? col.field
            : undefined
        "
      >
        <div class="header-with-filter">
          <span>{{ col.header }}</span>

          <!-- Sort icon only on Index & Health -->
          <p-sortIcon
            *ngIf="col.field === 'order' || col.field === 'matchStatus'"
            [field]="col.field"
          ></p-sortIcon>

          <!-- Link Type filter button (unchanged) -->
          <button
            *ngIf="col.field === 'type'"
            pButton
            type="button"
            class="p-button-text p-button-sm"
            icon="pi pi-chevron-down"
            (click)="typePanel?.toggle($event)"
            aria-label="Filter link types"
          ></button>
        </div>
      </th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-rowData let-rowIndex="rowIndex">
    <tr [pReorderableRow]="rowIndex" [pSelectableRow]="rowData">
      <td>
        <span
          class="pi pi-bars"
          pReorderableRowHandle
          aria-hidden="true"
        ></span>
      </td>

      <td *ngFor="let col of cols">
        <ng-container [ngSwitch]="col.field">
          <!-- Index -->
          <span *ngSwitchCase="'order'">{{ rowData.order }}</span>

          <!-- Link Type -->
          <span *ngSwitchCase="'type'">{{ rowData.type }}</span>

          <!-- Link name / variants -->
          <span *ngSwitchCase="'text'" [ngStyle]="getTextStyle(rowData)">
            <ng-container *ngIf="!rowData.hasTextConflict; else variantNames">
              {{ rowData.text }}
              <div class="muted" *ngIf="rowData.href">
                (
                <a
                  [href]="rowData.absUrl || rowData.href"
                  target="_blank"
                  rel="noopener"
                >
                  {{ rowData.absUrl || rowData.href }}
                </a>
                )
              </div>
            </ng-container>

            <ng-template #variantNames>
              <div>{{ rowData.text }}</div>
              <ul class="variant-list">
                <li *ngFor="let v of getOtherVariants(rowData)">{{ v }}</li>
              </ul>
              <div class="muted" *ngIf="rowData.href">
                (
                <a
                  [href]="rowData.absUrl || rowData.href"
                  target="_blank"
                  rel="noopener"
                >
                  {{ rowData.absUrl || rowData.href }}
                </a>
                )
              </div>
            </ng-template>
          </span>

          <!-- Pain points / rationale -->
          <span *ngSwitchCase="'explanation'">
            <span
              *ngIf="rowData.matchStatus === 'mismatch'; else noExp"
              class="exp-badge"
              role="note"
              [title]="buildMismatchReason(rowData)"
            >
              {{ buildMismatchReason(rowData) }}
            </span>
            <ng-template #noExp>—</ng-template>
          </span>

          <!-- Destination link content -->
          <span *ngSwitchCase="'destH1'" class="break-all">
            {{ rowData.destH1 || "—" }}
          </span>

          <!-- Health: same chip (icon + label) used in Component Guidance -->
          <span *ngSwitchCase="'matchStatus'">
            <span
              class="chip"
              [ngClass]="{
                'chip-severe': uiHealth(rowData) === 'severe',
                'chip-minor': uiHealth(rowData) === 'minor',
                'chip-ok': uiHealth(rowData) === 'ok',
                'chip-unk': uiHealth(rowData) === 'unknown',
              }"
            >
              <i
                class="pi"
                [ngClass]="{
                  'pi-exclamation-triangle': uiHealth(rowData) === 'severe',
                  'pi-times-circle': uiHealth(rowData) === 'minor',
                  'pi-check-circle': uiHealth(rowData) === 'ok',
                  'pi-question-circle': uiHealth(rowData) === 'unknown',
                }"
                aria-hidden="true"
              ></i>
              <span class="chip-label">{{
                healthLabel(uiHealth(rowData))
              }}</span>
            </span>
          </span>

          <!-- Fallback -->
          <span *ngSwitchDefault>{{ rowData[col.field] || "—" }}</span>
        </ng-container>
      </td>
    </tr>
  </ng-template>
</p-table>

<!-- Popover for Link Type (unchanged) -->
<p-popover
  #typePanel
  [dismissable]="true"
  [appendTo]="'body'"
  [styleClass]="'link-type-popover'"
>
  <div class="filter-panel">
    <button
      pButton
      type="button"
      class="p-button-text p-button-sm close-btn"
      icon="pi pi-times"
      (click)="typePanel.hide()"
      aria-label="Close filter"
    ></button>

    <div class="filter-row">
      <p-checkbox
        [(ngModel)]="allSelected"
        (onChange)="onAllToggle()"
        inputId="allTypes"
        binary="true"
      ></p-checkbox>
      <label class="filter-label" for="allTypes">ALL</label>
    </div>

    <div class="divider"></div>

    <div class="filter-row" *ngFor="let t of linkTypes; let i = index">
      <p-checkbox
        [(ngModel)]="typeChecks[t]"
        (onChange)="onTypeToggle(t)"
        [disabled]="allSelected"
        [inputId]="'type-' + i"
        binary="true"
      ></p-checkbox>
      <label class="filter-label" [attr.for]="'type-' + i">
        {{ t }}
      </label>
    </div>

    <div class="filter-muted" *ngIf="allSelected">
      All types are currently included.
    </div>
  </div>
</p-popover>

<!-- (Optional) Existing Match-status popover — keep if you still want it -->
<p-popover
  #statusPanel
  [dismissable]="true"
  [appendTo]="'body'"
  [styleClass]="'link-type-popover'"
>
  <div class="filter-panel">
    <button
      pButton
      type="button"
      class="p-button-text p-button-sm close-btn"
      icon="pi pi-times"
      (click)="statusPanel.hide()"
      aria-label="Close filter"
    ></button>

    <div class="filter-row">
      <p-checkbox
        [(ngModel)]="matchAllSelected"
        (onChange)="onMatchAllToggle()"
        inputId="allMatch"
        binary="true"
      ></p-checkbox>
      <label class="filter-label" for="allMatch">ALL</label>
    </div>

    <div class="divider"></div>

    <div class="filter-row">
      <p-checkbox
        [(ngModel)]="matchChecks.match"
        (pOnChange)="onMatchToggle('match')"
        [disabled]="matchAllSelected"
        inputId="ms-match"
        binary="true"
      ></p-checkbox>
      <label class="filter-label" for="ms-match">match</label>
    </div>

    <div class="filter-row">
      <p-checkbox
        [(ngModel)]="matchChecks.mismatch"
        (pOnChange)="onMatchToggle('mismatch')"
        [disabled]="matchAllSelected"
        inputId="ms-mismatch"
        binary="true"
      ></p-checkbox>
      <label class="filter-label" for="ms-mismatch">mismatch</label>
    </div>

    <div class="filter-muted" *ngIf="matchAllSelected">
      All match statuses are currently included.
    </div>
  </div>
</p-popover>
