<p-table
  [value]="tableRows"
  size="small"
  stripedRows
  [tableStyle]="{ 'min-width': '50rem' }"
  selectionMode="single"
  [(selection)]="selectedHeading"
  dataKey="order"
  metaKeySelection="false"
>
  <ng-template pTemplate="header">
    <tr>
      <th style="width: 3rem"></th>

      <th *ngFor="let col of cols">
        <div class="header-with-filter">
          <span>{{ col.header }}</span>

          <!-- Keep ONLY Link Type filter -->
          <button
            *ngIf="col.field === 'type'"
            pButton
            type="button"
            class="p-button-text p-button-sm"
            icon="pi pi-chevron-down"
            (click)="typePanel?.toggle($event)"
            aria-label="Filter link types"
          ></button>
        </div>
      </th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-rowData let-rowIndex="rowIndex">
    <tr [pReorderableRow]="rowIndex" [pSelectableRow]="rowData">
      <td>
        <span
          class="pi pi-bars"
          pReorderableRowHandle
          aria-hidden="true"
        ></span>
      </td>

      <td *ngFor="let col of cols">
        <ng-container [ngSwitch]="col.field">
          <span *ngSwitchCase="'order'">{{ rowData.order }}</span>

          <span *ngSwitchCase="'type'">{{ rowData.type }}</span>

          <span *ngSwitchCase="'text'" [ngStyle]="getTextStyle(rowData)">
            <!-- A) no variants -->
            <ng-container *ngIf="!rowData.hasTextConflict; else variantNames">
              {{ rowData.text }}
              <div class="muted" *ngIf="rowData.href">
                (
                <a
                  [href]="rowData.absUrl || rowData.href"
                  target="_blank"
                  rel="noopener"
                >
                  {{ rowData.absUrl || rowData.href }}
                </a>
                )
              </div>
            </ng-container>

            <!-- B) variants (different link names → same destination) -->
            <ng-template #variantNames>
              <div>{{ rowData.text }}</div>
              <ul class="variant-list">
                <li *ngFor="let v of getOtherVariants(rowData)">{{ v }}</li>
              </ul>
              <div class="muted" *ngIf="rowData.href">
                (
                <a
                  [href]="rowData.absUrl || rowData.href"
                  target="_blank"
                  rel="noopener"
                >
                  {{ rowData.absUrl || rowData.href }}
                </a>
                )
              </div>
            </ng-template>
          </span>

          <span *ngSwitchCase="'destH1'" class="break-all">
            {{ rowData.destH1 || "—" }}
          </span>

          <!-- 4-state health chip (icon + label) -->
          <span *ngSwitchCase="'matchStatus'" class="flex justify-center">
            <span
              class="chip"
              [ngClass]="{
                'chip-severe':
                  rowData.hasTextConflict ||
                  rowData.is404 ||
                  rowData.anchorMissing,
                'chip-minor':
                  !rowData.hasTextConflict &&
                  !rowData.is404 &&
                  !rowData.anchorMissing &&
                  rowData.matchStatus === 'mismatch',
                'chip-ok': rowData.matchStatus === 'match',
                'chip-unk':
                  rowData.matchStatus === 'unknown' ||
                  rowData.matchStatus === 'na',
              }"
            >
              <i
                class="pi"
                [ngClass]="{
                  'pi-exclamation-triangle':
                    rowData.hasTextConflict ||
                    rowData.is404 ||
                    rowData.anchorMissing,
                  'pi-times-circle':
                    !rowData.hasTextConflict &&
                    !rowData.is404 &&
                    !rowData.anchorMissing &&
                    rowData.matchStatus === 'mismatch',
                  'pi-check-circle': rowData.matchStatus === 'match',
                  'pi-question-circle':
                    rowData.matchStatus === 'unknown' ||
                    rowData.matchStatus === 'na',
                }"
                aria-hidden="true"
              ></i>
              <span class="chip-label">
                {{
                  rowData.hasTextConflict ||
                  rowData.is404 ||
                  rowData.anchorMissing
                    ? "Severe"
                    : rowData.matchStatus === "mismatch"
                      ? "Minor"
                      : rowData.matchStatus === "match"
                        ? "OK"
                        : "Unknown"
                }}
              </span>
            </span>
          </span>

          <!-- Pain points -->
          <span *ngSwitchCase="'explanation'">
            <span
              *ngIf="
                rowData.uiHealth === 'multi' || rowData.uiHealth === 'mismatch';
                else noExp
              "
              class="exp-badge"
              role="note"
              [title]="buildMismatchReason(rowData)"
            >
              {{ buildMismatchReason(rowData) }}
            </span>
            <ng-template #noExp>—</ng-template>
          </span>

          <span *ngSwitchCase="'searchTerm'">{{
            rowData.searchTerm || "—"
          }}</span>
          <span *ngSwitchCase="'clicks'">{{ rowData.clicks ?? "—" }}</span>

          <span *ngSwitchDefault>{{ rowData[col.field] || "—" }}</span>
        </ng-container>
      </td>
    </tr>
  </ng-template>
</p-table>

<!-- Link Type popover (kept) -->
<p-popover
  #typePanel
  [dismissable]="true"
  [appendTo]="'body'"
  [styleClass]="'link-type-popover'"
>
  <div class="filter-panel">
    <button
      pButton
      type="button"
      class="p-button-text p-button-sm close-btn"
      icon="pi pi-times"
      (click)="typePanel.hide()"
      aria-label="Close filter"
    ></button>

    <div class="filter-row">
      <p-checkbox
        [(ngModel)]="allSelected"
        (onChange)="onAllToggle()"
        inputId="allTypes"
        binary="true"
      ></p-checkbox>
      <label class="filter-label" for="allTypes">ALL</label>
    </div>

    <div class="divider"></div>

    <div class="filter-row" *ngFor="let t of linkTypes; let i = index">
      <p-checkbox
        [(ngModel)]="typeChecks[t]"
        (onChange)="onTypeToggle(t)"
        [disabled]="allSelected"
        [inputId]="'type-' + i"
        binary="true"
      ></p-checkbox>
      <label class="filter-label" [attr.for]="'type-' + i">
        {{ t }}
      </label>
    </div>

    <div class="muted" *ngIf="allSelected">
      All types are currently included.
    </div>
  </div>
</p-popover>
