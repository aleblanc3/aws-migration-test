<p-table
  [value]="tableRows"
  dataKey="url"
  styleClass="p-datatable-sm"
  [(selection)]="selectedRows"
  selectionMode="multiple"
  [customSort]="true"
  (sortFunction)="onCustomSort($event)"
>
  <ng-template pTemplate="header">
    <tr>
      <!-- checkbox column -->
      <th style="width: 3rem; text-align: center">
        <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
      </th>

      <!-- Index -->
      <th pSortableColumn="order">
        <span>Index</span>
        <p-sortIcon field="order"></p-sortIcon>
      </th>

      <!-- Component -->
      <th>
        <span>Component</span>
      </th>

      <!-- UCDG guidance URL -->
      <th>
        <span>UCDG guidance</span>
      </th>

      <!-- Health (custom sort) -->
      <th pSortableColumn="health" class="health-col">
        <span>Health</span>
        <p-sortIcon field="health"></p-sortIcon>
      </th>

      <!-- Pain points (not sortable) -->
      <th>Pain points</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-row let-rowIndex="rowIndex">
    <tr [pSelectableRow]="row">
      <!-- checkbox cell -->
      <td style="text-align: center">
        <p-tableCheckbox [value]="row"></p-tableCheckbox>
      </td>

      <!-- Index -->
      <td>{{ row.order }}</td>

      <!-- Component -->
      <td>{{ row.component }}</td>

      <!-- URL -->
      <td>
        <a [href]="row.url" target="_blank" rel="noopener">{{ row.url }}</a>
      </td>

      <!-- Health -->
      <td class="health-cell health-col">
        <span
          class="chip"
          [ngClass]="{
            'chip-severe': row.health === 'severe',
            'chip-minor': row.health === 'minor',
            'chip-ok': row.health === 'ok',
            'chip-unk': !row.health || row.health === 'unknown',
          }"
        >
          <i
            class="pi"
            [ngClass]="{
              'pi-exclamation-triangle': row.health === 'severe',
              'pi-times-circle': row.health === 'minor',
              'pi-check-circle': row.health === 'ok',
              'pi-question-circle': !row.health || row.health === 'unknown',
            }"
            aria-hidden="true"
          ></i>
          <span class="chip-label">
            {{ healthLabel(row.health) }}
          </span>
        </span>
      </td>

      <!-- Pain points -->
      <td>
        <div *ngIf="(row.issues?.length || 0) > 0; else rationaleOnly">
          <ul class="issues">
            <li *ngFor="let it of row.issues">{{ it }}</li>
          </ul>
          <div class="muted" *ngIf="row.rationale">{{ row.rationale }}</div>
        </div>
        <ng-template #rationaleOnly>
          <span>{{ row.rationale || "â€”" }}</span>
        </ng-template>
      </td>
    </tr>
  </ng-template>
</p-table>

<!-- GenAI action button -->
<div class="mt-3">
  <button
    pButton
    type="button"
    class="ai-btn"
    [label]="'Get GenAI recommendations based on user data'"
    [icon]="'pi pi-sparkles'"
    aria-label="Get GenAI recommendations based on user data"
    (click)="sendToAI()"
    [disabled]="!selectedRows.length || isLoading"
    pTooltip="Select one or more components"
    [showDelay]="1000"
    [hideDelay]="300"
  >
    <span class="sr-only">Get GenAI recommendations based on user data</span>
  </button>
</div>
